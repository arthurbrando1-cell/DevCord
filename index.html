<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevCord | File & Voice</title>
    <style>
        :root {
            --bg-servers: #1e1f22; --bg-channels: #2b2d31; --bg-chat: #313338;
            --bg-input: #383a40; --accent: #5865f2; --success: #23a559;
            --danger: #f23f42; --text-main: #dbdee1; --text-muted: #949ba4;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'gg sans', sans-serif; background: var(--bg-chat); color: var(--text-main); overflow: hidden; }
        #app { display: flex; height: 100vh; }

        /* Estilos de Mensagem */
        .msg-wrapper { display: flex; gap: 15px; padding: 5px 16px; position: relative; }
        .msg-wrapper:hover { background: rgba(0,0,0,0.05); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); background-size: cover; flex-shrink: 0; }
        .chat-img { max-width: 300px; max-height: 400px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        
        /* Input Area */
        .input-area { padding: 0 16px 24px; }
        .input-wrapper { background: var(--bg-input); border-radius: 8px; display: flex; align-items: center; padding: 0 12px; gap: 12px; }
        #message-input { flex-grow: 1; padding: 12px; background: transparent; border: none; color: white; outline: none; }
        
        .icon-btn { cursor: pointer; font-size: 20px; color: var(--text-muted); transition: 0.2s; }
        .icon-btn:hover { color: white; }
        .recording-active { color: var(--danger); animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% {opacity:1} 50% {opacity:0.5} 100% {opacity:1} }
        
        /* Esconder input de arquivo padrÃ£o */
        #file-input { display: none; }

        /* Chat Scroll */
        #msg-container { flex-grow: 1; overflow-y: auto; padding: 20px 0; display: flex; flex-direction: column; }
    </style>
</head>
<body>

    <div id="app">
        <main style="flex-grow:1; display:flex; flex-direction:column;">
            <div id="msg-container"></div>
            
            <div class="input-area">
                <div class="input-wrapper">
                    <label for="file-input" class="icon-btn">âž•</label>
                    <input type="file" id="file-input" accept="image/*" onchange="uploadImage(this)">
                    
                    <input type="text" id="message-input" placeholder="Conversar...">
                    
                    <span id="mic-btn" class="icon-btn" onclick="handleVoice()">ðŸŽ¤</span>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    // Para funcionar pra valer, vocÃª usaria: 
    // import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = { /* SEU CONFIG AQUI */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let mediaRecorder;
    let audioChunks = [];

    // --- ENVIAR MENSAGEM ---
    async function sendMessage(content, type = 'text') {
        const user = auth.currentUser;
        if (!user) return;

        await addDoc(collection(db, "mensagens_geral"), {
            uid: user.uid,
            user: user.email.split('@')[0],
            content: content,
            type: type, // 'text', 'image', ou 'audio'
            createdAt: serverTimestamp()
        });
    }

    // --- UPLOAD DE IMAGEM ---
    window.uploadImage = (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                // SIMULAÃ‡ÃƒO: No Storage real, vocÃª faria upload do 'file' e pegaria a URL
                // Aqui usamos a URL temporÃ¡ria do navegador (Base64)
                sendMessage(e.target.result, 'image');
            };
            reader.readAsDataURL(file);
        }
        input.value = ""; // limpa o input
    };

    // --- GRAVAÃ‡ÃƒO DE ÃUDIO ---
    window.handleVoice = async () => {
        const btn = document.getElementById('mic-btn');
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(blob);
                sendMessage(audioUrl, 'audio');
            };

            mediaRecorder.start();
            btn.classList.add('recording-active');
            btn.innerText = "ðŸ›‘";
        } else {
            mediaRecorder.stop();
            btn.classList.remove('recording-active');
            btn.innerText = "ðŸŽ¤";
        }
    };

    // --- ESCUTAR MENSAGENS ---
    const q = query(collection(db, "mensagens_geral"), orderBy("createdAt", "asc"));
    onSnapshot(q, (snap) => {
        const cont = document.getElementById('msg-container');
        cont.innerHTML = '';
        snap.forEach(d => {
            const m = d.data();
            let contentHtml = `<div class="msg-text">${m.content}</div>`;
            
            if (m.type === 'image') {
                contentHtml = `<img src="${m.content}" class="chat-img" onclick="window.open(this.src)">`;
            } else if (m.type === 'audio') {
                contentHtml = `<audio controls src="${m.content}"></audio>`;
            }

            cont.innerHTML += `
                <div class="msg-wrapper">
                    <div class="avatar"></div>
                    <div class="msg-content">
                        <span style="font-weight:bold">${m.user}</span>
                        ${contentHtml}
                    </div>
                </div>
            `;
        });
        cont.scrollTop = cont.scrollHeight;
    });

    // Enter para enviar texto
    document.getElementById('message-input').onkeypress = (e) => {
        if(e.key === 'Enter' && e.target.value.trim()){
            sendMessage(e.target.value, 'text');
            e.target.value = "";
        }
    };
</script>
</body>
</html>
