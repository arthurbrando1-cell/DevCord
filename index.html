<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevCord | Friends & Explore</title>
    <style>
        :root {
            --bg-servers: #1e1f22; --bg-channels: #2b2d31; --bg-chat: #313338;
            --bg-input: #383a40; --accent: #5865f2; --success: #23a559;
            --text-main: #dbdee1; --text-muted: #949ba4;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'gg sans', sans-serif; background: var(--bg-chat); color: var(--text-main); overflow: hidden; }
        #app { display: flex; height: 100vh; }

        /* SIDEBAR SERVIDORES */
        .sidebar-servers { width: 72px; background: var(--bg-servers); display: flex; flex-direction: column; align-items: center; padding-top: 12px; gap: 8px; flex-shrink: 0; }
        .server-icon { width: 48px; height: 48px; background: var(--bg-chat); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; background-size: cover; background-position: center; color: white; position: relative; }
        .server-icon:hover, .server-icon.active { border-radius: 30%; background-color: var(--accent); }
        .icon-search { color: var(--success); } .icon-search:hover { background: var(--success) !important; color: white; }

        /* EXPLORAR (TELA CHEIA) */
        #explore-screen { position: fixed; inset: 0; background: var(--bg-chat); z-index: 4000; display: none; flex-direction: column; align-items: center; padding: 40px; }
        .search-bar { width: 100%; max-width: 600px; padding: 15px; border-radius: 8px; border: none; background: var(--bg-input); color: white; font-size: 18px; margin-bottom: 20px; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; width: 100%; max-width: 1000px; }
        .srv-card { background: var(--bg-channels); padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; }

        /* DM & AMIGOS */
        .dm-item { padding: 10px; margin: 2px 8px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 10px; }
        .dm-item:hover { background: rgba(255,255,255,0.05); }

        /* MODAIS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 5000; }
        .modal-content { background: #313338; padding: 24px; border-radius: 8px; width: 400px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 4px; border: none; background: #1e1f22; color: white; box-sizing: border-box; }
        
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; }
        #msg-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
    </style>
</head>
<body>

    <div id="explore-screen">
        <button onclick="closeExplore()" style="align-self: flex-end; background: none; border: none; color: white; cursor: pointer; font-size: 20px;">‚úï Fechar</button>
        <h1>Descubra sua comunidade</h1>
        <input type="text" class="search-bar" id="search-input" placeholder="Aonde voc√™ quer ir hoje?" oninput="searchServers()">
        <div class="results-grid" id="search-results"></div>
    </div>

    <div id="modal-friend" class="modal">
        <div class="modal-content">
            <h3>Adicionar Amigo</h3>
            <p style="font-size: 12px; color: var(--text-muted);">Voc√™ pode adicionar amigos pelo Nickname deles.</p>
            <input type="text" id="friend-nick-input" placeholder="Digite o Nickname">
            <button onclick="addFriendByNick()" style="width:100%; padding:10px; background:var(--accent); color:white; border:none; border-radius:4px; cursor:pointer">Enviar pedido</button>
            <button onclick="document.getElementById('modal-friend').style.display='none'" style="width:100%; margin-top:5px; background:none; color:white; border:none; cursor:pointer">Cancelar</button>
        </div>
    </div>

    <div id="app">
        <nav class="sidebar-servers">
            <div class="server-icon" onclick="showDM()" style="background-color: var(--accent);">DM</div>
            <div style="width:32px; height:2px; background: #35363c; margin: 4px 0;"></div>
            <div id="my-servers-list"></div>
            <div class="server-icon icon-search" onclick="openExplore()">üîç</div>
        </nav>

        <aside class="sidebar-channels">
            <div id="side-header" class="header">Mensagens Diretas</div>
            <div id="dm-list-container">
                <div class="dm-item" style="color: var(--success); font-weight: bold;" onclick="document.getElementById('modal-friend').style.display='flex'">+ Adicionar Amigo</div>
                <div id="friends-list"></div>
            </div>
            <div id="channel-list-container" style="display:none">
                <div style="padding:15px 10px 5px; color:var(--text-muted); font-size:12px;">CANAIS DE TEXTO</div>
                <div id="channel-list"></div>
            </div>
        </aside>

        <main class="chat-area">
            <div class="header"># <span id="current-chat-title">In√≠cio</span></div>
            <div id="msg-container"></div>
            <div style="padding: 16px;">
                <input type="text" id="message-input" placeholder="Conversar..." style="background: var(--bg-input); margin:0">
            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, doc, query, orderBy, onSnapshot, serverTimestamp, getDocs, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { /* USE SEU CONFIG AQUI */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentMode = "DM"; // DM ou SERVER
    let activeChatId = null;
    let unsubMsgs = null;

    // --- EXPLORAR ---
    window.openExplore = () => document.getElementById('explore-screen').style.display = 'flex';
    window.closeExplore = () => document.getElementById('explore-screen').style.display = 'none';

    window.searchServers = async () => {
        const val = document.getElementById('search-input').value.toLowerCase();
        const q = query(collection(db, "todos_servidores"));
        const snap = await getDocs(q);
        const res = document.getElementById('search-results');
        res.innerHTML = '';
        snap.forEach(d => {
            if(d.data().nome.toLowerCase().includes(val)) {
                const card = document.createElement('div');
                card.className = 'srv-card';
                card.innerHTML = `<h4>${d.data().nome}</h4><button onclick="joinServer('${d.id}')">Entrar</button>`;
                res.appendChild(card);
            }
        });
    };

    window.joinServer = async (id) => {
        await setDoc(doc(db, "membros", `${auth.currentUser.uid}_${id}`), { uid: auth.currentUser.uid, srvId: id });
        closeExplore();
    };

    // --- AMIGOS E DM ---
    window.addFriendByNick = async () => {
        const nick = document.getElementById('friend-nick-input').value;
        const q = query(collection(db, "usuarios"), where("nick", "==", nick));
        const snap = await getDocs(q);
        if(!snap.empty) {
            const friendId = snap.docs[0].id;
            await setDoc(doc(db, "amigos", `${auth.currentUser.uid}_${friendId}`), { 
                uids: [auth.currentUser.uid, friendId],
                users: [auth.currentUser.uid, friendId]
            });
            alert("Amigo adicionado!");
        } else { alert("Usu√°rio n√£o encontrado!"); }
    };

    function listenFriends() {
        const q = query(collection(db, "amigos"), where("uids", "array-contains", auth.currentUser.uid));
        onSnapshot(q, async (snap) => {
            const list = document.getElementById('friends-list');
            list.innerHTML = '';
            for (const d of snap.docs) {
                const friendId = d.data().uids.find(id => id !== auth.currentUser.uid);
                const uDoc = await getDoc(doc(db, "usuarios", friendId));
                const div = document.createElement('div');
                div.className = 'dm-item';
                div.innerText = uDoc.exists() ? uDoc.data().nick : "Usu√°rio";
                div.onclick = () => startDM(d.id, div.innerText);
                list.appendChild(div);
            }
        });
    }

    window.startDM = (chatId, name) => {
        activeChatId = chatId;
        currentMode = "DM";
        document.getElementById('current-chat-title').innerText = name;
        loadChat(`dms_${chatId}`);
    };

    // --- CHAT ---
    function loadChat(path) {
        if(unsubMsgs) unsubMsgs();
        const q = query(collection(db, path), orderBy("createdAt", "asc"));
        unsubMsgs = onSnapshot(q, (snap) => {
            const cont = document.getElementById('msg-container');
            cont.innerHTML = '';
            snap.forEach(d => {
                cont.innerHTML += `<div style="margin-bottom:8px"><b>${d.data().user}:</b> ${d.data().text}</div>`;
            });
            cont.scrollTop = cont.scrollHeight;
        });
    }

    document.getElementById('message-input').onkeypress = async (e) => {
        if(e.key === 'Enter' && e.target.value.trim()) {
            const path = currentMode === "DM" ? `dms_${activeChatId}` : `msgs_${activeChatId}`;
            await addDoc(collection(db, path), {
                text: e.target.value,
                user: auth.currentUser.email.split('@')[0],
                uid: auth.currentUser.uid,
                createdAt: serverTimestamp()
            });
            e.target.value = "";
        }
    };

    onAuthStateChanged(auth, (user) => { if(user) listenFriends(); });

</script>
</body>
</html>
